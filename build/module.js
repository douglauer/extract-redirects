// Generated by IcedCoffeeScript 1.7.1-b
(function() {
  var e, extract, hosts, iced, links, log, needle, url, _, __iced_deferrals, __iced_k, __iced_k_noop,
    __slice = [].slice,
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  iced = {
    Deferrals: (function() {
      function _Class(_arg) {
        this.continuation = _arg;
        this.count = 1;
        this.ret = null;
      }

      _Class.prototype._fulfill = function() {
        if (!--this.count) {
          return this.continuation(this.ret);
        }
      };

      _Class.prototype.defer = function(defer_params) {
        ++this.count;
        return (function(_this) {
          return function() {
            var inner_params, _ref;
            inner_params = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            if (defer_params != null) {
              if ((_ref = defer_params.assign_fn) != null) {
                _ref.apply(null, inner_params);
              }
            }
            return _this._fulfill();
          };
        })(this);
      };

      return _Class;

    })(),
    findDeferral: function() {
      return null;
    },
    trampoline: function(_fn) {
      return _fn();
    }
  };
  __iced_k = __iced_k_noop = function() {};

  _ = require('lodash');

  log = function() {
    var x;
    x = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    return console.log.apply(console, x);
  };

  url = require('url');

  needle = require('needle');

  _.type = function(obj) {
    if (obj === 'undefined' || obj === null) {
      return false;
    }
    return Object.prototype.toString.call(obj).slice(8, -1).toLowerCase();
  };

  module.exports = extract = function(url, opt, cb) {
    var e, history, r, req_opt, ___iced_passed_deferral, __iced_deferrals, __iced_k, _ref;
    __iced_k = __iced_k_noop;
    ___iced_passed_deferral = iced.findDeferral(arguments);
    if (!cb && _.type(opt) === 'function') {
      cb = opt;
      opt = {};
    }
    history = [];
    req_opt = {
      read_timeout: 15000,
      headers: {
        'User-Agent': (_ref = opt.agent) != null ? _ref : 'extract-redirects/robot'
      }
    };
    (function(_this) {
      return (function(__iced_k) {
        var _results, _while;
        _results = [];
        _while = function(__iced_k) {
          var _break, _continue, _next;
          _break = function() {
            return __iced_k(_results);
          };
          _continue = function() {
            return iced.trampoline(function() {
              return _while(__iced_k);
            });
          };
          _next = function(__iced_next_arg) {
            _results.push(__iced_next_arg);
            return _continue();
          };
          if (!1) {
            return _break();
          } else {
            history.push(url);
            (function(__iced_k) {
              __iced_deferrals = new iced.Deferrals(__iced_k, {
                parent: ___iced_passed_deferral,
                filename: "/private/var/www/z/modules/extract-redirects/module.iced"
              });
              needle.get(url, req_opt, __iced_deferrals.defer({
                assign_fn: (function() {
                  return function() {
                    e = arguments[0];
                    return r = arguments[1];
                  };
                })(),
                lineno: 28
              }));
              __iced_deferrals._fulfill();
            })(function() {
              if (e) {
                return cb(e);
              }
              (function(__iced_k) {
                if (r.headers.location) {
                  return __iced_k(url = r.headers.location);
                } else {
                  (function(__iced_k) {
_break()
                  })(__iced_k);
                }
              })(_next);
            });
          }
        };
        _while(__iced_k);
      });
    })(this)((function(_this) {
      return function() {
        if (opt.hosts_only) {
          history = _.uniq(_.compact(_.map(history, function(item) {
            var parsed, parts, _ref1, _ref2;
            try {
              parsed = require('url').parse(item);
              parts = [parsed.protocol, '//', (_ref1 = (_ref2 = parsed.host) != null ? _ref2 : parsed.hostname) != null ? _ref1 : null];
              if (__indexOf.call(parts, null) >= 0) {
                return null;
              }
              return parts.join('');
            } catch (_error) {
              return null;
            }
          })));
        }
        return cb(null, history);
      };
    })(this));
  };

  if (process.env.TAKY_DEV) {
    (function(_this) {
      return (function(__iced_k) {
        __iced_deferrals = new iced.Deferrals(__iced_k, {
          filename: "/private/var/www/z/modules/extract-redirects/module.iced"
        });
        extract('http://google.com', __iced_deferrals.defer({
          assign_fn: (function() {
            return function() {
              e = arguments[0];
              return links = arguments[1];
            };
          })(),
          lineno: 56
        }));
        __iced_deferrals._fulfill();
      });
    })(this)((function(_this) {
      return function() {
        log(/links/);
        log(links);
        (function(__iced_k) {
          __iced_deferrals = new iced.Deferrals(__iced_k, {
            filename: "/private/var/www/z/modules/extract-redirects/module.iced"
          });
          extract('http://google.com', {
            hosts_only: true
          }, __iced_deferrals.defer({
            assign_fn: (function() {
              return function() {
                e = arguments[0];
                return hosts = arguments[1];
              };
            })(),
            lineno: 60
          }));
          __iced_deferrals._fulfill();
        })(function() {
          log(/hosts/);
          log(hosts);

          /*
          /links/
          [ 'http://x.com/v1/public/click/81dayvknb489',
            'http://affiliate.x.com/rd/r.php?sid=1823&pub=220662&c1=&c2=&c3=',
            'https://www.x.com/special/?affid=gos&saffid=220662' ]
          /hosts/
          [ 'http://x.com',
            'http://affiliate.x.com',
            'https://www.x.com' ]
           */
          return __iced_k(process.exit(0));
        });
      };
    })(this));
  } else {
    __iced_k();
  }

}).call(this);
